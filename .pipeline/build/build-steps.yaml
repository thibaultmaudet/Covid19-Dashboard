steps:
  - checkout: self
    fetchDepth: 1
    submodules: true
    clean: true

  - task: NuGetToolInstaller@1
    displayName: Ensure NuGet Installer

  - task: VisualStudioTestPlatformInstaller@1
    displayName: Ensure VSTest Platform

  - task: NuGetCommand@2
    displayName: Restore NuGet packages for Covid19Dashboard.sln
    inputs:
      restoreSolution: Covid19Dashboard.sln

  - task: VSBuild@1
    displayName: 'Build Covid19Dashboard.sln'
    inputs:
      solution: '**\Covid19Dashboard.sln'
      platform: '$(BuildPlatform)'
      configuration: '$(BuildConfiguration)'
      msbuildArgs: '/p:AppxBundlePlatforms="$(buildPlatform)" /p:AppxPackageDir="$(appxPackageDir)" /p:AppxBundle=Always /p:UapAppxPackageBuildMode=StoreUpload /p:AppxPackageSigningEnabled=false'
      maximumCpuCount: true

  - task: VSTest@2
    displayName: 'Tests'
    condition: ne(variables['BuildPlatform'], 'arm64') # No arm64 agents to run the tests.
    inputs:
      platform: '$(BuildPlatform)'
      configuration: '$(BuildConfiguration)'
      testSelector: 'testAssemblies'
      testAssemblyVer2: |
        **\*test*.dll
        !**\*TestAdapter.dll
        !**\obj\**
      searchFolder: '$(System.DefaultWorkingDirectory)'
      codeCoverageEnabled: true
